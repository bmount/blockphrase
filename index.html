<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="lib/pixymaps.min.js"></script>
    <script type="text/javascript" src="lib/d3.v2.min.js"></script>
    <style type="text/css">

body {
  font: 10px sans-serif;
}

#container {
  width: 400px;
  height: 400px;
  overflow: hidden;
}

</style>
  </head>
  <body>
    <div id=container>
      <canvas id=map></canvas>
    </div>
    <script type="text/javascript">

function bucketEdges (ctx) {
  var px = ctx.getImageData(0,0, ctx.canvas.height, ctx.canvas.width);
  var edges = [0,1,0,1], idx;
  for (var k = 0; k < px.height; k++) {
    for (var i = 0; i < px.width; i++) {
      idx = (k * px.width + i) * 4
      if (px.data[idx] > 199) px.data[idx] = 2;
      else { px.data[idx] = 200; }
    }
  }
  ctx.putImageData(px, 0, 0)
}

function flood (px, w0, x0, y0, ov, nv, xf, yf, rewrite) {
  var stk = [[x0, y0]]
    , c, x, y;
  var maxes = [x0, y0];
  var mins = [x0, y0];
  while (stk.length) {
    c = stk.pop();
    x = c[0];
    y = c[1];
    if (px[(y*w0 + x)*4] != ov) { 
      continue;
    }
    else {
      px[(y*w0 + x)*4] = nv;
      if (rewrite) { 
        rewrite.data[((y-rewrite.yoff)*rewrite.w + x - rewrite.xoff)*4] = 0;
      }
      if (x > maxes[0]) { maxes[0]=x }
      if (y > maxes[1]) { maxes[1]=y }
      if (x < mins[0])  { mins[0]=x }
      if (y < mins[1])  { mins[1]=y }
      //if (x <= 0) return false;
      //if (y <= 0) return false;
      //if (x >= xf) return false;
      //if (x >= yf) return false;
      stk.push([x, y-1]);
      stk.push([x, y+1]);
      stk.push([x+1, y]);
      stk.push([x-1, y]);
    }
  }

  return [mins, maxes]
}

var canvas = d3.select("#map"),
    context = canvas.node().getContext("2d");

var w = 400,
    h = 400,
    lon = -122.41948,
    lat = 37.76487;

var project = d3.geo.mercator()
    .scale(1)
    .translate([.5, .5]);

var view = pixymaps.view()
    .size([w, h])
    .center(project([lon, lat]))
    .zoom(15);

var image = pixymaps.image()
    .view(view)
  .url(pixymaps.url("/devtiles/{Z}-{X}-{Y}.png"))
  // for stamen tiles via proxy for getImageData work-around:
  //.url(pixymaps.url("/toner-background/{Z}/{X}/{Y}.png"))
    .render(canvas.node());

document.addEventListener("DOMContentLoaded", function () {
  //bucketEdges(context);
})


var redness = 0;
var blockShapes = [];
d3.select("#map").on("click", function (evt, a, b, c) {
    redness++;
    var borderw = 3; // min space between blocks when rendered
    var x = d3.event.offsetX //.clientX
      , y = d3.event.offsetY //.clientY;
    var oc = context.getImageData(x, y, 1, 1); 
    oc = (oc.data[0]);
    var px = context.getImageData(0,0, context.canvas.height, context.canvas.width);
    var extent = flood(px.data, px.width, x, y, oc, 
      redness, context.canvas.width, context.canvas.height, false);
    if (!extent) return false;
    /**/
    var csl = document.createElement("canvas");
    csl.setAttribute("id", extent.toString());
    csl.width = extent[1][0] - extent[0][0] + borderw;
    csl.height = extent[1][1] - extent[0][1] + borderw;
    //csl.width = 900;
    //csl.height = 900;
    cctx = csl.getContext('2d');
    cctx.fillStyle = 'rgba(255,255,255,1)';
    cctx.fillRect(0,0,csl.width,csl.height);
    cctx.fill();
    var cslImg = cctx.getImageData(0,0,csl.width, csl.height);
    var robj = {w: parseInt(csl.width), h: parseInt(csl.height), yoff: extent[0][1], 
      data: cslImg.data, xoff: extent[0][0]}
    var cslextent = flood(px.data, px.width, x, y, redness, 
      redness+1, context.canvas.width, context.canvas.height,
      robj);
    cctx.putImageData(cslImg, 0, 0);
    document.body.appendChild(csl);
    /**/
    context.putImageData(px, 0, 0);
  })

    /*
    if (flood(px.data, px.width, x, y, 255, 0)) {
      context.beginPath()
      context.arc(x, y, 10, 0, Math.PI*2, true);
      context.closePath()
      context.fill()
    } 
    */

</script>

<div id="copy">
      &copy;
      Map data from
      <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a> and
      <a href="http://stamen.com">Stamen Design</a>
    </div>
  </body>
</html>
