<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="lib/pixymaps.min.js"></script>
    <script type="text/javascript" src="lib/d3.v2.min.js"></script>
    <style type="text/css">

body {
  font: 10px sans-serif;
}

#container {
  width: 400px;
  height: 400px;
  overflow: hidden;
}

</style>
  </head>
  <body>
    <div id=container>
      <canvas id=map></canvas>
    </div>
    <script type="text/javascript">

function flood (px, w0, x0, y0, ov, nv, xf, yf, rewrite) {
  var stk = [[x0, y0]]
    , c, x, y;
  var maxes = [x0, y0];
  var mins = [x0, y0];
  while (stk.length) {
    c = stk.pop();
    x = c[0];
    y = c[1];
    if (px[(y*w0 + x)*4] != ov) { 
      continue;
    }
    else {
      px[(y*w0 + x)*4] = nv;
      if (rewrite) { 
        rewrite.data[((y-rewrite.yoff)*rewrite.w + x - rewrite.xoff)*4] = 0;
      }
      if (x > maxes[0]) { maxes[0]=x }
      if (y > maxes[1]) { maxes[1]=y }
      if (x < mins[0])  { mins[0]=x }
      if (y < mins[1])  { mins[1]=y }
      //if (x <= 0) return false;
      //if (y <= 0) return false;
      //if (x >= xf) return false;
      //if (x >= yf) return false;
      stk.push([x, y-1]);
      stk.push([x, y+1]);
      stk.push([x+1, y]);
      stk.push([x-1, y]);
    }
  }
  return [mins, maxes]
}

function pxMap (lon, lat) {
var canvas = d3.select("#map"),
    context = canvas.node().getContext("2d");

var w = 400,
    h = 400,
    lon = lon || -122.41948,
    lat = lat || 37.76487;

var project = d3.geo.mercator()
    .scale(1)
    .translate([.5, .5]);

var view = pixymaps.view()
    .size([w, h])
    .center(project([lon, lat]))
    .zoom(15);
var image = pixymaps.image()
    .view(view)
  //.url(pixymaps.url("/devtiles/{Z}-{X}-{Y}.png"))
  // for stamen tiles via proxy for getImageData work-around:
    .url(pixymaps.url("/toner-background/{Z}/{X}/{Y}.png"))
    .render(canvas.node(), function () { centralPark() });

var redness = 0;
var blockShapes = [];
//d3.select("#map").on("click", function (evt, a, b, c) {
function floodcheck (x, y) {
    redness++;
    var borderw = 3; // min space between blocks when rendered
    //var x = d3.event.offsetX //.clientX
    //  , y = d3.event.offsetY //.clientY;
    var oc = 255; //context.getImageData(x, y, 1, 1); 
    //oc = (oc.data[0]);
    var px = context.getImageData(0,0, context.canvas.height, context.canvas.width);
    var extent = flood(px.data, px.width, x, y, oc, 
        10, context.canvas.width, context.canvas.height, false);
    //console.log('extent', extent);
    if (!extent) return false;
    /**/
    var csl = document.createElement("canvas");
    csl.setAttribute("id", extent.toString());
    csl.width = extent[1][0] - extent[0][0] + borderw;
    csl.height = extent[1][1] - extent[0][1] + borderw;
    //csl.width = 900;
    //csl.height = 900;
    cctx = csl.getContext('2d');
    cctx.fillStyle = 'rgba(255,255,255,1)';
    cctx.fillRect(0,0,csl.width,csl.height);
    cctx.fill();
    var cslImg = cctx.getImageData(0,0,csl.width, csl.height);
    var robj = {w: parseInt(csl.width), h: parseInt(csl.height), yoff: extent[0][1], 
      data: cslImg.data, xoff: extent[0][0]}
    var cslextent = flood(px.data, px.width, x, y, 10, 
      2, context.canvas.width, context.canvas.height,
      robj);
    cctx.putImageData(cslImg, 0, 0);
    document.body.appendChild(csl);
    /**/
    context.putImageData(px, 0, 0);
    return extent;
}

    /*
    if (flood(px.data, px.width, x, y, 255, 0)) {
      context.beginPath()
      context.arc(x, y, 10, 0, Math.PI*2, true);
      context.closePath()
      context.fill()
    } 
    */

function renderArea () {
  var x = 200
    , y = 200
    , nxt = false
    , dx, dy;
  for (var i = -100; i < 100; i+=10) {
    for (var j = -100; j < 100; j+=10) {
      x = 200 + i -
        parseInt(canvas.node().style.webkitTransform.split(',')[12]);
      y = 200 + j - 
        parseInt(canvas.node().style.webkitTransform.split(',')[13]);
      //console.log(x, y);
      //console.log('canvas', canvas);
      if (context.getImageData(x, y, 1, 1).data[0] < 100) continue;
      nxt = floodcheck(parseInt(x), parseInt(y));
      dx = Math.abs(nxt[0][1] - nxt[0][0]);
      dy = Math.abs(nxt[1][1] - nxt[1][0]);
    }
  }
  // couple of oddballs not sure why ->
  d3.selectAll('canvas[width="3"]').remove()
}
return renderArea
}

var centralPark = pxMap(-73.98 , 40.78);

</script>

<div id="copy">
      &copy;
      Map data from
      <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a> and
      <a href="http://stamen.com">Stamen Design</a>
    </div>
  </body>
</html>

